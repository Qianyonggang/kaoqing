{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-1">{{ team['name'] }} - 考勤登记</h4>
    <p class="text-muted mb-0">支持 0.5/1 天的加减，每天范围 -1 到 1。</p>
  </div>
  <a class="btn btn-outline-primary" href="{{ url_for('team_detail', team_id=team['id']) }}">返回团队</a>
</div>

<form method="get" class="row g-3 mb-3">
  <div class="col-auto">
    <label class="form-label">日期</label>
    <input class="form-control" type="date" name="date" value="{{ work_date }}" max="{{ today }}" />
  </div>
  <div class="col-md-4">
    <label class="form-label">搜索员工</label>
    <input class="form-control" name="q" placeholder="姓名或电话" value="{{ search_keyword }}" />
  </div>
  <div class="col-auto d-flex align-items-end">
    <button class="btn btn-outline-secondary" type="submit">切换日期</button>
  </div>
</form>

<form method="post">
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>姓名</th>
          <th>联系方式</th>
          <th>工作天数</th>
          <th>本月总天数（{{ month_prefix }}）</th>
          <th>备注</th>
        </tr>
      </thead>
      <tbody>
        {% for member in members %}
        {% set record = attendance_map.get(member['id']) %}
        {% set base_total = (total_units_map.get(member['id'], 0) - (record['work_units'] if record else 0)) %}
        <tr>
          <td>{{ member['name'] }}</td>
          <td>{{ member['phone'] }}</td>
          <td style="max-width: 140px;">
            <div class="input-group attendance-input" data-base-total="{{ base_total }}" data-step="0.5">
              <button class="btn btn-outline-secondary btn-sm" type="button" data-delta="-1">-1</button>
              <button class="btn btn-outline-secondary btn-sm" type="button" data-delta="-0.5">-0.5</button>
              <input
                class="form-control text-center"
                type="number"
                step="0.5"
                min="-1"
                max="1"
                name="work_units_{{ member['id'] }}"
                value="{{ record['work_units'] if record else 0 }}"
              />
              <button class="btn btn-outline-secondary btn-sm" type="button" data-delta="0.5">+0.5</button>
              <button class="btn btn-outline-secondary btn-sm" type="button" data-delta="1">+1</button>
            </div>
          </td>
          <td>
            <span class="total-days" data-total>{{ base_total + (record['work_units'] if record else 0) }}</span>
          </td>
          <td>
            <input
              class="form-control"
              name="notes_{{ member['id'] }}"
              value="{{ record['notes'] if record else '' }}"
            />
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-muted text-center">暂无成员</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <button class="btn btn-primary" type="submit">保存考勤</button>
</form>

<script>
  document.querySelectorAll('.attendance-input').forEach((group) => {
    const step = parseFloat(group.dataset.step || '0.5');
    const baseTotal = parseFloat(group.dataset.baseTotal || '0');
    const input = group.querySelector('input');
    const totalCell = group.closest('tr').querySelector('[data-total]');
    const clampValue = (value) => Math.max(-1, Math.min(1, value));
    const updateTotal = (value) => {
      if (!totalCell) return;
      const total = baseTotal + value;
      totalCell.textContent = Number.isFinite(total) ? total.toFixed(2).replace(/\\.00$/, '') : '0';
    };
    updateTotal(parseFloat(input.value || '0'));
    group.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) return;
      event.preventDefault();
      const current = parseFloat(input.value || '0');
      const delta = parseFloat(button.dataset.delta || `${button.dataset.action === 'increase' ? step : -step}`);
      const next = clampValue(current + delta);
      input.value = Number.isFinite(next) ? next.toFixed(2).replace(/\\.00$/, '') : '0';
      updateTotal(next);
    });
    input.addEventListener('input', () => {
      const current = clampValue(parseFloat(input.value || '0'));
      input.value = Number.isFinite(current) ? current.toFixed(2).replace(/\\.00$/, '') : '0';
      updateTotal(current);
    });
  });
</script>
{% endblock %}
